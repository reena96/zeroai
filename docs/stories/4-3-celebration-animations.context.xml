<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Celebration Animations</title>
    <status>review</status>
    <generatedAt>2025-11-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-3-celebration-animations.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a student</asA>
    <iWant>to see a fun celebration when I solve a problem</iWant>
    <soThat>I feel rewarded and motivated to continue</soThat>
    <tasks>
- Task 1: Install and configure confetti library (AC: #1, #6)
  - Subtask 1.1: Install canvas-confetti or react-confetti package
  - Subtask 1.2: Create CelebrationAnimation component wrapper
  - Subtask 1.3: Configure confetti options (duration, colors, particle count)
  - Subtask 1.4: Test confetti renders smoothly without blocking UI

- Task 2: Create celebration message system (AC: #2, #4, #5)
  - Subtask 2.1: Define array of 5+ celebration message variations
  - Subtask 2.2: Create randomization logic for message selection
  - Subtask 2.3: Format message to include streak/problem count data
  - Subtask 2.4: Create CelebrationToast component for message display

- Task 3: Integrate celebrations into problem-solved workflow (AC: #3)
  - Subtask 3.1: Trigger celebration when X-Problem-Solved header is 'true'
  - Subtask 3.2: Replace console.log milestone messages with celebration calls
  - Subtask 3.3: Pass streak and problem count data to celebration component
  - Subtask 3.4: Ensure celebration doesn't block continued interaction

- Task 4: Responsive design and accessibility (AC: #7, #8)
  - Subtask 4.1: Test celebration animation on mobile/tablet/desktop
  - Subtask 4.2: Verify confetti particles scale appropriately
  - Subtask 4.3: Ensure toast message readable on all screen sizes
  - Subtask 4.4: Add prefers-reduced-motion media query support (note for future)

- Task 5: Polish and timing (AC: #3, #6)
  - Subtask 5.1: Fine-tune confetti duration (2-3 seconds)
  - Subtask 5.2: Add smooth fade-in/fade-out for toast message
  - Subtask 5.3: Coordinate timing of confetti and message
  - Subtask 5.4: Test feels rewarding not annoying (subjective but important)

- Task 6: Testing and edge cases (All ACs)
  - Subtask 6.1: Test first problem celebration
  - Subtask 6.2: Test milestone celebrations (7 day streak, 10 problems)
  - Subtask 6.3: Test message randomization (no repeats on consecutive solves)
  - Subtask 6.4: Test responsive behavior on different screen sizes
  - Subtask 6.5: Test rapid problem solving (multiple celebrations in quick succession)
    </tasks>
  </story>

  <acceptanceCriteria>
1. Confetti animation triggers when student solves problem correctly
2. Encouraging message displays: "You did it! üéâ", "Nice work! ‚≠ê", "Excellent! Keep it up! üí™"
3. Animation lasts 2-3 seconds, non-blocking (student can continue)
4. Messages vary to avoid repetition (5+ variations)
5. Celebration includes streak update: "You did it! üî• 6 day streak!"
6. Animation feels rewarding not annoying (smooth, tasteful)
7. Works on all screen sizes (responsive)
8. Option to disable animations in settings (future: for now always on)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-7.3 Celebration Animations</section>
        <snippet>Confetti animation when solving problems, encouraging messages with streak updates, 5+ message variations to avoid repetition.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Animations</section>
        <snippet>canvas-confetti 1.9.4 for celebration effects, client-side rendering, component pattern with 'use client' directive.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-4-gamification-polish.md</path>
        <title>Epic 4: Gamification & Polish</title>
        <section>Story 4.3</section>
        <snippet>Layer on engagement features, makes learning sticky. Prerequisites: Story 4.1 (streak), Story 4.2 (problems count).</snippet>
      </doc>
      <doc>
        <path>docs/stories/4-1-daily-streak-tracker.md</path>
        <title>Story 4.1: Daily Streak Tracker</title>
        <section>Milestone Celebrations</section>
        <snippet>Milestone detection returns MilestoneInfo with reached flag and message. Currently logs to console, Story 4.3 adds visual display.</snippet>
      </doc>
      <doc>
        <path>docs/stories/4-2-problems-solved-counter.md</path>
        <title>Story 4.2: Problems Solved Counter</title>
        <section>Problem Milestones</section>
        <snippet>Problem milestones at 10, 25, 50, 100 with encouragement messages. Console logging ready for Story 4.3 visual celebration integration.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>store/gamification.ts</path>
        <kind>state-store</kind>
        <symbol>useGamificationStore</symbol>
        <lines>18-22</lines>
        <reason>MilestoneInfo interface defines structure for milestone detection returns. Used by incrementStreak() and incrementProblemCount().</reason>
      </artifact>
      <artifact>
        <path>components/MessageInput.tsx</path>
        <kind>component</kind>
        <symbol>MessageInput</symbol>
        <lines>108-122</lines>
        <reason>Integration point for celebrations. Has TODO comments for Story 4.3. Contains console.log calls to be replaced with visual celebrations.</reason>
      </artifact>
      <artifact>
        <path>lib/celebration.ts</path>
        <kind>utility</kind>
        <symbol>triggerConfetti, formatCelebrationMessage</symbol>
        <lines>1-87</lines>
        <reason>Celebration utility functions implemented in Story 4.3. Handles confetti animation and message formatting.</reason>
      </artifact>
      <artifact>
        <path>components/CelebrationToast.tsx</path>
        <kind>component</kind>
        <symbol>CelebrationToast</symbol>
        <lines>1-44</lines>
        <reason>Toast message display component implemented in Story 4.3. Shows celebration messages with auto-dismiss.</reason>
      </artifact>
    </code>
    <dependencies>
      <npm>
        <package>canvas-confetti</package>
        <version>^1.9.4</version>
      </npm>
      <npm>
        <package>@types/canvas-confetti</package>
        <version>latest</version>
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
- Client component pattern: Use 'use client' directive at top of component files
- Error handling: Wrap confetti triggers in try-catch with graceful fallback
- Non-blocking UX: Celebrations must not prevent user from continuing to interact
- Responsive design: Test on mobile, tablet, and desktop screen sizes
- Timing: Confetti duration 2-3 seconds, toast fade-in 300ms, fade-out 500ms
- Message variety: Minimum 5 celebration message variations with randomization
- Integration: Replace console.log milestone messages in MessageInput.tsx lines 108-109, 119-122
- Milestone data: Use MilestoneInfo interface from gamification store
- Z-index management: Toast at z-50 to appear above content but not block interaction
  </constraints>
  <interfaces>
    <interface>
      <name>MilestoneInfo</name>
      <kind>TypeScript Interface</kind>
      <signature>interface MilestoneInfo { reached: boolean; milestone?: number; message?: string; }</signature>
      <path>store/gamification.ts:18-22</path>
    </interface>
    <interface>
      <name>triggerConfetti</name>
      <kind>Function</kind>
      <signature>function triggerConfetti(): void</signature>
      <path>lib/celebration.ts</path>
    </interface>
    <interface>
      <name>formatCelebrationMessage</name>
      <kind>Function</kind>
      <signature>function formatCelebrationMessage(streak: number, totalProblems: number): string</signature>
      <path>lib/celebration.ts</path>
    </interface>
    <interface>
      <name>X-Problem-Solved Header</name>
      <kind>API Response Header</kind>
      <signature>X-Problem-Solved: 'true' | 'false'</signature>
      <path>app/api/chat/route.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Manual testing only per ADR-004 (no automated tests for MVP). Focus on subjective UX quality: celebrations should feel rewarding not annoying. Test on multiple screen sizes. Use browser DevTools for responsive testing and console for debugging milestone triggers.</standards>
    <locations>N/A - Manual testing only</locations>
    <ideas>
      <test ac="1">Solve problem correctly ‚Üí verify confetti appears</test>
      <test ac="2,4">Solve 5 problems in succession ‚Üí verify 5 different celebration messages appear</test>
      <test ac="3">During confetti animation ‚Üí verify can type new problem immediately (non-blocking)</test>
      <test ac="5">Reach milestone (7 day streak) ‚Üí verify celebration includes streak data in message</test>
      <test ac="6">Subjective feel test ‚Üí celebrations exciting but not annoying</test>
      <test ac="7">Test responsive behavior on mobile (iPhone 12), tablet (iPad), desktop (1440px)</test>
      <test edge-case="rapid-solving">Solve 3 problems in 10 seconds ‚Üí verify celebrations don't stack awkwardly</test>
      <test edge-case="long-messages">Narrow screen ‚Üí verify toast wraps text properly</test>
    </ideas>
  </tests>
</story-context>
